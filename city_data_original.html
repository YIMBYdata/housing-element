<!DOCTYPE html>
<html lang="en">
	<head>
		<script>

		  <!-- Sonja: Download your CSV from Airtable, and paste the contents inside the backticks (let csv = `.....`) below! -->

		  let csv = ``
		</script>

		<meta charset="UTF-8">
		<meta name="Description" content="RHNA Data for California Cities">
		<title>City Stats: RHNA Data</title>
		<style>
			:root {
				--text-primary: #333;
				--text-strong: #111;
				--theme-primary: #269;
				--background-primary: #eaeaea;
				--background-secondary: #dadada;
				--divider: #aaa;
				--header-font-size: 26px;
				--edge-margin: 2ch;
				--text-width: 70em;
			}
			body {
				background: var(--background-primary);
				color: var(--text-primary);
				display: block;
				font-family: 'Helvetica', 'Arial', sans-serif;
				font-size: 16px;
				line-height: 1.5;
				margin: 0 auto;
				max-width: var(--text-width);
			}
			main {
				margin: 12px var(--edge-margin);;
			}
			h3 {
				margin: 5px;
			}
			a {
				color: var(--theme-primary);
				cursor: pointer;
				text-decoration: none;
			}
			a:hover {
				text-decoration: underline;
			}
			.page-header {
				align-items: center;
				background: var(--background-primary);
				border-bottom: 1px solid var(--divider);
				display: flex;
				margin: 0 var(--edge-margin);
				padding: 12px 0;
				top: 0;
			}
			.page-header h1 {
				color: var(--text-strong);
				display: inline;
				font-size: 36px;
			}
			.page-header a {
				margin: 0 5px 0 1px;
			}
			select {
				font-size: 0.9em;
			}
			#rhna-table {
				margin: 5px auto;
				border: 1px solid #ccc;
				border-spacing: 0;
			}
			td {
				padding: 2px 5px;
			}
			tr:nth-child(odd) {
				background-color: var(--background-secondary);
			}
			#rhna-data {
				margin: 10px auto;
				display: none;
			}
			.grid-container {
				display: grid;
				grid-template-columns: repeat(auto-fill, minmax(350px, 800px));
				/*changed max to 800 px to make the maximum columns 2, idk if that works */
				/* This is better for small screens, once min() is better supported */
				/* grid-template-columns: repeat(auto-fill, minmax(min(200px, 100%), 1fr)); */
				grid-gap: 1rem;
				margin: 10px 0;
			}
			.grid-item {
				background-color: #dadada;
				padding: 10px;
			}
			.text-info {
				font-size: 12pt;
			}
			.progress-item {
				background-color: #fdd;
			}
			.due-item {
				background-color: #ffd;
			}
			.due-days-big {
				font-size: 16pt;
			}
			.cta-button {
				border: 1px solid #ddd;
				background: #c75250;
				box-shadow: none;
				border-radius: 3px;
				cursor: pointer;
				padding: 5px;
				font-size: 1.1em;
				margin: 10px 0;
			}
			.cta-button:hover {
				background: #f07c7a;
			}
			.credits {
				font-size: 10pt;
				margin: 5px;
				text-align: center;
			}
			.control-area {
				text-align: center;
			}
			.todo {
				background-color: #91000f;
				color: #fff !important;
				padding: 5px;
				margin: 2px;
			}
			.ext-link {
				font-size: 0.85em;
			}
		</style>
		<!-- Responsive viewport on mobile -->
		<meta name="viewport" content="width=device-width">
		<!--chart.js library for displaying charts and graphs -->
		<script src='https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.min.js'></script>
		<!--airtable library for displaying table -->
		<script src='airtable.browser.js'></script>
	</head>
	<body>
		<header class="page-header">
		</header>
		<main>
			<div class="control-area">
				<div>
					<span>Find your city:</span>
					<select id="rhna-selector" onchange="selectionChanged(document.getElementById('rhna-selector').value);">
						<option>Select a city...</option>
					</select>
				</div>
				<!-- <div>
					<button class="cta-button" onclick="window.open(volunteerLink,'_blank')">Volunteer!</button>
				</div> -->
			</div>
			<div id='rhna-data'>
				<div class="grid-container">
					<div class="grid-item">
						<div class="text-info">
							<div>Jurisdiction: <span id="jurisdiction"></span></div>
							<div>County: <span id="county"></span></div>
							<div>Council of Governments <span id="cog"></span></div>
						</div>
					</div>
					<div class="grid-item progress-item">
						<div class="text-info">
							<div>6th Cycle RHNA: <span id="6th-count"></span></div>
							<div>5th Cycle RHNA: <span id="5th-count"></span></div>
							<div>Last cycle's progress: <span id="progress-blame"></span></div>
						</div>
					</div>
					<div class="grid-item">
						<div class="text-info">
							<div><b>High progress score?</b></div>
							<div>It might not be a good sign. The most exclusive and anti-housing jurisdictions were typically able to ensure that their RHNA would be very low. Fortunately, the legislature has changed the allocation process to make the allocations more fair in the 6th cycle.</div>
						</div>
					</div>
					<div class="grid-item due-item">
						<div class="text-info">
							<div>Your city's housing element is due in: </div>
							<div class="due-days-big"><span id="element-due-days"></span> days</div> <!-- center text-->
							<div>On: <span id="element-due-date"></span></div>
						</div>
					</div>
					<div class="grid-item">
						<div id="rhna-charts">
						</div>
					</div>
					<div class="grid-item">
						<div class="text-info cta-volunteer">
							<div>Your city has <b><span id="countVolunteers"></span></b> volunteer watchdogs.</div>
							<div id="cta-text"></div>
<!-- TODO: If countVolunteers >= 1 print: 'WE NEED YOU' else 'JOIN THE FUN' -->
							<button class="cta-button" onclick="window.open(volunteerLink,'_blank')">Volunteer!</button>
						</div>
					</div>
					<div class="grid-item">
						<div class="text-info resource-links">
							<div><b>Resource Links</b></div>

							<div>6th Cycle Housing Element Draft: <a href="#" id="6th-element" class="ext-link"></a></div>
<!--TODO: If 6th-element is empty 
<button class="cta-button" onclick="window.open(volunteerLink,'_blank')">WE NEED YOU TO FILL THIS IN</button> -->

							<div>5th Cycle Housing Element: <a href="#" id="5th-element" class="ext-link"></a></div>
							<div class="todo">TODO: Finish adding data to this section.</div>
						</div>
					</div>
				</div>
				<table id="rhna-table">
				</table>
			</div>
			<div class="credits">Much love and thanks to volunteer extraordinaire <a href="https://hunn.io">Dylan Hunn</a> for creating this beautiful dashboard!</div>
		</main>

		<script>

			function selectionChanged(cityName) {
				const cityData = values[cityName];
				clearCharts();
				populateJurisdictionBoxForCity(cityData);
				populateStatementForCity(cityData);
				populateDueDaysForCity(cityData);
				populateIncomeHistogramForCity(cityData);
				populateResourceLinksForCity(cityData);
				populateTableForCity(cityData);
				document.getElementById('rhna-data').style.display = 'block';
				window.location.hash = cityName;
			}

			// Populates the select dropdown with all cities from values.
			function populateSelectorWithCities() {
				const selector = document.getElementById('rhna-selector');
				let cityNames = Object.keys(values);
				cityNames.sort(); // Show in alpha order.
				cityNames.forEach(name => {
					const opt = document.createElement('option');
					opt.innerText = name;
					opt.value = name;
					selector.appendChild(opt);
				});
			}
			
			// Clears the contents of rhna-table and populates it with the specified array of data, cityArr.
			// cityArr must have exactly as many elements as the cols array.
			function populateTableForCity(cityArr) {
				const table = document.getElementById('rhna-table');
				table.innerHTML = '';
				const headerRow = document.createElement('tr');
				const header = document.createElement('th');
				header.setAttribute('colspan', '2');
				header.innerText = `Raw Data For ${cityArr[jurisdiction]}`;
				headerRow.appendChild(header);
				table.appendChild(headerRow);              
				for (let i = 0; i < cols.length; i++) {
					const row = document.createElement('tr');
					const keyCell = document.createElement('td');
					const valueCell = document.createElement('td');

					keyCell.innerText = cols[i];
					let value = cityArr[i];
					if (value === '0 checked out of 1') {
						value = 'No';
					} else if (value === '1 checked out of 1') {
						value = 'Yes';
					}
					valueCell.innerText = value;

					row.appendChild(keyCell);
					row.appendChild(valueCell);
					table.appendChild(row);
				}
			}

			function clearCharts() {
			  const charts = document.getElementById('rhna-charts');
			  charts.innerHTML = '';
			}

			function populateIncomeHistogramForCity(cityArr) {
			  const charts = document.getElementById('rhna-charts');
			  const canvas = document.createElement('canvas');
			  canvas.height = 200;
			  canvas.width = 400;
			  charts.appendChild(canvas);

			  const ctx = canvas.getContext('2d');
			  

			  const chart = new Chart(ctx, {
				type: 'bar',
				data: {
				  labels: [cols[vli], cols[li], cols[mi], cols[ami]],
				  datasets: [
					{
					  label: "6th Cycle RHNA",
					  backgroundColor: ["#3e95cd", "#8e5ea2","#3cba9f","#e8c3b9"],
					  data: [cityArr[vli], cityArr[li], cityArr[mi], cityArr[ami]],
					}
				  ]
				},
				options: {
				  legend: { display: false },
				  title: {
					display: true,
					fontSize: 16,
					fontColor: '#000',
					text: "6th Cycle RHNA Allocation: By Income"
				  },
				  scales: {
						yAxes: [{
							ticks: {
								beginAtZero: true
							}
						}]
					}
				}
			  });
			}

			function populateJurisdictionBoxForCity(cityArr) {
				document.getElementById('jurisdiction').innerText = cityArr[jurisdiction];
				document.getElementById('county').innerText = cityArr[county];
				document.getElementById('cog').innerText = cityArr[council];
			}

			function populateDueDaysForCity(cityArr) {
				today = new Date();
				const dueDateStr = cityArr[duedate];
				const due = new Date(dueDateStr);
				const one_day = 1000 * 60 * 60 * 24;
				const days_left = Math.floor((due.getTime() - today.getTime()) / one_day);
				document.getElementById('element-due-date').innerText = dueDateStr;
				document.getElementById('element-due-days').innerText = days_left;
			}

			function populateStatementForCity(cityArr) {
			  const statement = document.getElementById('progress-statement');
			  const progress = cityArr[prog];

			  document.getElementById('5th-count').innerText = cityArr[rhna5];
			  document.getElementById('6th-count').innerText = cityArr[rhna6];
			  
			  if (progress === "" || progress === "NaN" || progress === "0" || progress === "0%" || progress === "0.0%") {
				return; // No percent competion data.
			  }

			  const blame = document.getElementById('progress-blame');
			  let numericPct = parseFloat(progress) / 100.0;
			  if (numericPct < 0.5) {
				blame.innerText = `${progress} ðŸ˜ž`;
				blame.style.color = 'red';
			  } else if (numericPct < 0.9) {
				blame.innerText = `${progress} ðŸ˜`;
				blame.style.color = 'orange';
			  } else if (numericPct < 2.0) {
				blame.innerText =  `${progress} ðŸ˜Š`;
				blame.style.color = 'green';
			  } else {
				blame.innerText =  `${progress} ðŸ¤” Something is up!`;
				blame.style.color = 'green';
			  }
			}

			function populateResourceLinksForCity(cityArr) {
				const fifthElemLink = document.getElementById("5th-element");
				const sixthElemDraftLink = document.getElementById("6th-element");
				fifthElemLink.href = cityArr[fifthElement];
				fifthElemLink.innerText = cityArr[fifthElement];
				sixthElemDraftLink.href = cityArr[elemDraft];
				sixthElemDraftLink.innerText = cityArr[elemDraft];
			}

			// ref: http://stackoverflow.com/a/1293163/2343
			// This will parse a delimited string into an array of
			// arrays. The default delimiter is the comma, but this
			// can be overriden in the second argument.
			function CSVToArray( strData, strDelimiter ){
				// Check to see if the delimiter is defined. If not,
				// then default to comma.
				strDelimiter = (strDelimiter || ",");
				// Create a regular expression to parse the CSV values.
				var objPattern = new RegExp(
					(
						// Delimiters.
						"(\\" + strDelimiter + "|\\r?\\n|\\r|^)" +
						// Quoted fields.
						"(?:\"([^\"]*(?:\"\"[^\"]*)*)\"|" +
						// Standard fields.
						"([^\"\\" + strDelimiter + "\\r\\n]*))"
					),
					"gi"
					);
				// Create an array to hold our data. Give the array
				// a default empty first row.
				var arrData = [[]];
				// Create an array to hold our individual pattern
				// matching groups.
				var arrMatches = null;
				// Keep looping over the regular expression matches
				// until we can no longer find a match.
				while (arrMatches = objPattern.exec( strData )){
					// Get the delimiter that was found.
					var strMatchedDelimiter = arrMatches[ 1 ];
					// Check to see if the given delimiter has a length
					// (is not the start of string) and if it matches
					// field delimiter. If id does not, then we know
					// that this delimiter is a row delimiter.
					if (
						strMatchedDelimiter.length &&
						strMatchedDelimiter !== strDelimiter
						){
						// Since we have reached a new row of data,
						// add an empty row to our data array.
						arrData.push( [] );
					}
					var strMatchedValue;
					// Now that we have our delimiter out of the way,
					// let's check to see which kind of value we
					// captured (quoted or unquoted).
					if (arrMatches[ 2 ]){
						// We found a quoted value. When we capture
						// this value, unescape any double quotes.
						strMatchedValue = arrMatches[ 2 ].replace(
							new RegExp( "\"\"", "g" ),
							"\""
							);
					} else {
						// We found a non-quoted value.
						strMatchedValue = arrMatches[ 3 ];
					}
					// Now that we have our value string, let's add
					// it to the data array.
					arrData[ arrData.length - 1 ].push( strMatchedValue );
				}
				// Return the parsed data.
				return( arrData );
			}

			function transformCSVData(csv) {
			  const array = CSVToArray(csv);
			  array.shift(); // Remove header row
			  const obj = {};
			  array.forEach(e => obj[e[0]] = e);
			  return obj;
			}

			function getAirtableBase() {
				var Airtable = require('airtable');
				var base = new Airtable({apiKey: 'keyZHNl5mF6KiNGzA'}).base('appRD2z3VXs78iq80');
				return base;
			}

// is the easiest thing to have a function whose input is "base" from above, and whose output is a csv called "csv" ? That way all of the code written for the copy+pasted csv can be reused? Or is it better to make functions whose inputs are (base, record ID) and look up the values for the cities each time?

			function getCitiesFromAirtable(base) {
				const cities = [];
				base('Cities').select({
				    view: "Main View" // shouldn't the view name be "City Data"? "City View" is a subset of "Main View" so it is smaller
				}).eachPage(function page(records, fetchNextPage) {
					const city = {};
				    records.forEach(function(record) {
				    	cols.forEach(c => city[c] = record.get(c));
				    });
				    cities.push(city);
				    fetchNextPage();
				}, function done(err) {
					console.log(cities);
				    if (err) { console.error(err); return; }
				});
			}
			
			let values = transformCSVData(csv);
			let cols = CSVToArray(csv)[0];

			// Indices into the table.
			const rhna6 = cols.indexOf(cols.filter(s => s.includes('RHNA (current)'))[0]);
			const rhna5 = cols.indexOf(cols.filter(s => s.includes('5th Cycle RHNA'))[0]);
			const jurisdiction = cols.indexOf(cols.filter(s => s.includes('Jurisdiction'))[0]);
			const county = cols.indexOf(cols.filter(s => s.includes('County'))[0]);
			const council = cols.indexOf(cols.filter(s => s.includes('COG'))[0]);
			const duedate = cols.indexOf(cols.filter(s => s.includes('Due Date'))[0]);
			const elemDraft = cols.indexOf(cols.filter(s => s.includes('Housing Element Draft'))[0]);
			const fifthElement = cols.indexOf(cols.filter(s => s.includes('5th Cycle Housing Element'))[0]);
			const vli = cols.indexOf(cols.filter(s => s.includes('VLI'))[0]);
			const li = vli + 1;
			const mi = vli + 2;
			const ami = vli + 3;
			const prog = cols.indexOf(cols.filter(s => s.includes('Progress'))[0]);
			
			const volunteerLink = 'https://airtable.com/shr9fipLLj1WTHKu7';

			// new variables made by SKT below
			const finalAllocation = cols.indexOf(cols.filter(s => s.includes('Final Allocation'))[0]);
			const countVolunteers = cols.indexOf(cols.filter(s => s.includes('Interested Volunteers'))[0]);
			const population = cols.indexOf(cols.filter(s => s.includes('Population'))[0]);
			const area = cols.indexOf(cols.filter(s => s.includes('Area'))[0]);
			const density = cols.indexOf(cols.filter(s => s.includes('Density'))[0]);
			

			populateSelectorWithCities();

			if (window.location.hash.length > 1) {
				const hash = decodeURI(document.location.hash.substring(1));
				document.getElementById('rhna-selector').value = hash;
				console.log(hash);
				selectionChanged(hash);
			}

		</script>
	</body>
</html>
